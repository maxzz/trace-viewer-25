(function(){"use strict";const y={Unknown:0,Entry:62,Exit:60,Group:71,Data:68,Error:69,Time:84,Day:116,DayRestarted:78,Utf8:85,Key:75};class I{static FT_KEY_LEN=16;static DEFAULT_KEY=new Uint8Array([98,11,5,61,254,12,228,229,31,77,9,75,1,73,223,17]);keys=[];constructor(){}addKey(s,n){console.warn("Encrypted session keys (LINECODE::Key) logic not yet implemented. Skipping key.")}getCryptKey(s){let n=I.DEFAULT_KEY;if(this.keys.length>0&&this.keys.length>0){let e=this.keys[0].key;for(let t=1;t<this.keys.length;t++){if(s<this.keys[t].offset)return e;e=this.keys[t].key}return e}return n}decrypt(s,n){const e=this.getCryptKey(s),t=n.length,c=new Uint8Array(t),r=new Int32Array(4),i=new DataView(e.buffer,e.byteOffset,e.byteLength);for(let l=0;l<4;l++)r[l]=i.getInt32(l*4,!0);r[0]^=593824053,r[1]^=2036606352,r[2]^=1367369848,r[3]^=2436109881;const o=new Int32Array(2);o[0]=889808163,o[1]=2020114513;const d=new ArrayBuffer(8),a=new Int32Array(d),u=new Uint8Array(d);a[0]=889808163,a[1]=2020114513;let h=t,x=0,g=0;const E=-1640531527;for(;h>0;){let l=a[0],p=a[1],C=0;const w=h>8?8:h;for(let f=0;f<32;f++){C=C+E|0;const A=(p<<4)+r[0]|0,D=p+C|0;(p>>>5)+r[1]|0;const L=(p>>5)+r[1]|0,F=A^D^L;l=l+F|0;const O=(l<<4)+r[2]|0,K=l+C|0,R=(l>>5)+r[3]|0,_=O^K^R;p=p+_|0}a[0]=l,a[1]=p;for(let f=0;f<w;f++)c[g+f]=n[x+f]^u[f];for(let f=0;f<w;f++)u[f]=n[x+f];h-=w,x+=w,g+=w}return c}}function k(m){let s=m.replace(/hResult([:=\s]+)(-?\d+)/g,(n,e,t)=>{try{const r=(parseInt(t,10)>>>0).toString(16).toUpperCase();return`hResult${e.includes(":")?": ":e.includes("=")?"=":" "}0x${r}`}catch{return n}});if(s===m){const n=m.match(/^\s*(-?\d+)\s*$/);if(n)try{const c=`0x${(parseInt(n[1],10)>>>0).toString(16).toUpperCase()}`;return c===b?b:c}catch{}}return s}const b="0x80070002";class T{threadId;lines=[];indent=0;constructor(s){this.threadId=s}}class U{lines=[]}class S{buffer;dataView;crypto;decoderUtf8=new TextDecoder("utf-8");decoderAnsi=new TextDecoder("windows-1252");header={magic:""};lines=[];threadFlows=new Map;timeFlow=new U;currentTime="";currentDate="";constructor(s){this.buffer=s,this.dataView=new DataView(s),this.crypto=new I}parse(){let s=0;const n=new Uint8Array(this.buffer);let e=0;for(let i=0;i<Math.min(4096,n.length);i++)if(n[i]===10&&n[i+1]===46){e=i+2,n[e]===13&&e++,n[e]===10&&e++;break}if(e===0){console.error("Could not find end of header");return}const t=this.decoderAnsi.decode(n.slice(0,e));this.header.rawText=t,this.parseHeaderLines(t),s=e;let c=0;const r=this.buffer.byteLength;for(;s<r&&!(s+7>r);){const i=this.dataView.getUint32(s,!0),o=this.dataView.getUint8(s+4),d=this.dataView.getUint16(s+5,!0),a=s+7,u=a+d;if(u>r){console.warn("Line extends beyond file size",s);break}const h=new Uint8Array(this.buffer,a,d);let x=h;o===y.Key?this.crypto.addKey({headerOffset:s,lineFileNumber:c,lineIndent:0,threadId:i,code:o,strLength:d},h):d>0&&(x=this.crypto.decrypt(s,h));let g="",E;if(d>0){const w=this.processTextContent(d,o,x);g=w.text,E=w.textColor}o===y.Error&&(g=k(g)),o===y.Time&&(this.currentTime=g),(o===y.Day||o===y.DayRestarted)&&(this.currentDate=g),this.threadFlows.has(i)||this.threadFlows.set(i,new T(i));const l=this.threadFlows.get(i);let p=l.indent;o===y.Entry?l.indent++:o===y.Exit&&(l.indent>0&&l.indent--,p=l.indent);const C={lineIndex:c,fileOffset:s,threadId:i,code:o,length:d,content:g,indent:p,timestamp:this.currentTime,date:this.currentDate,textColor:E};this.lines.push(C),s=u,c++}}parseHeaderLines(s){s.split(/\r?\n/).forEach(e=>{e.startsWith("trace3")?this.header.magic="trace3":e.startsWith("Compiled:")?this.header.compiled=e.substring(10).trim():e.startsWith("OS:")?this.header.os=e.substring(4).trim():e.startsWith("Machine name:")&&(this.header.machineName=e.substring(14).trim())})}processTextContent(s,n,e){let t="",c;n===y.Utf8?t=this.decoderUtf8.decode(e):t=this.decoderAnsi.decode(e);const r="'`I",i="`'",o=t.indexOf(r);if(o!==-1&&t.length>=o+r.length+2+i.length){const d=o+r.length,a=t.substring(d,d+2),u=d+2;if(t.substring(u,u+i.length)===i){const h=parseInt(a,16);if(!isNaN(h)&&h>=0&&h<=15){c=this.getColorFromIndex(h);const x=r.length+2+i.length;t=t.substring(0,o)+t.substring(o+x)}}}return{text:t,textColor:c}}getColorFromIndex(s){return["text-black","text-blue-900","text-green-700","text-teal-700","text-red-900","text-purple-800","text-yellow-700","text-gray-400","text-gray-500","text-blue-600","text-lime-500","text-cyan-500","text-red-600","text-fuchsia-500","text-yellow-400","text-white"][s]||""}}self.onmessage=function(s){const{type:n,arrayBuffer:e}=s.data;if(n==="PARSE")try{const t=new S(e);t.parse();const c=t.lines,r=t.lines.filter(a=>a.code!==y.Time),i=Array.from(new Set(t.lines.map(a=>a.threadId))).sort((a,u)=>a-u),o=t.lines.filter(a=>a.code===y.Error).length,d={type:"SUCCESS",data:{rawLines:c,viewLines:r,uniqueThreadIds:i,header:t.header,errorCount:o}};self.postMessage(d)}catch(t){const c={type:"ERROR",error:t.message||"Unknown error during parsing"};self.postMessage(c)}}})();
