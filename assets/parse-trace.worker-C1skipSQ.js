(function(){"use strict";const w={Unknown:0,Entry:62,Exit:60,Group:71,Data:68,Error:69,Time:84,Day:116,DayRestarted:78,Utf8:85,Key:75};class b{static FT_KEY_LEN=16;static DEFAULT_KEY=new Uint8Array([98,11,5,61,254,12,228,229,31,77,9,75,1,73,223,17]);keys=[];constructor(){}addKey(t,o){console.warn("Encrypted session keys (LINECODE::Key) logic not yet implemented. Skipping key.")}getCryptKey(t){let o=b.DEFAULT_KEY;if(this.keys.length>0&&this.keys.length>0){let s=this.keys[0].key;for(let e=1;e<this.keys.length;e++){if(t<this.keys[e].offset)return s;s=this.keys[e].key}return s}return o}decrypt(t,o){const s=this.getCryptKey(t),e=o.length,d=new Uint8Array(e),n=new Int32Array(4),r=new DataView(s.buffer,s.byteOffset,s.byteLength);for(let c=0;c<4;c++)n[c]=r.getInt32(c*4,!0);n[0]^=593824053,n[1]^=2036606352,n[2]^=1367369848,n[3]^=2436109881;const i=new Int32Array(2);i[0]=889808163,i[1]=2020114513;const l=new ArrayBuffer(8),a=new Int32Array(l),y=new Uint8Array(l);a[0]=889808163,a[1]=2020114513;let h=e,g=0,x=0;const C=-1640531527;for(;h>0;){let c=a[0],u=a[1],m=0;const p=h>8?8:h;for(let f=0;f<32;f++){m=m+C|0;const A=(u<<4)+n[0]|0,U=u+m|0;(u>>>5)+n[1]|0;const D=(u>>5)+n[1]|0,L=A^U^D;c=c+L|0;const F=(c<<4)+n[2]|0,S=c+m|0,K=(c>>5)+n[3]|0,O=F^S^K;u=u+O|0}a[0]=c,a[1]=u;for(let f=0;f<p;f++)d[x+f]=o[g+f]^y[f];for(let f=0;f<p;f++)y[f]=o[g+f];h-=p,g+=p,x+=p}return d}}class k{threadId;lines=[];indent=0;constructor(t){this.threadId=t}}class E{lines=[]}class T{buffer;dataView;crypto;decoderUtf8=new TextDecoder("utf-8");decoderAnsi=new TextDecoder("windows-1252");header={magic:""};lines=[];threadFlows=new Map;timeFlow=new E;currentTime="";currentDate="";constructor(t){this.buffer=t,this.dataView=new DataView(t),this.crypto=new b}parse(){let t=0;const o=new Uint8Array(this.buffer);let s=0;for(let r=0;r<Math.min(4096,o.length);r++)if(o[r]===10&&o[r+1]===46){s=r+2,o[s]===13&&s++,o[s]===10&&s++;break}if(s===0){console.error("Could not find end of header");return}const e=this.decoderAnsi.decode(o.slice(0,s));this.header.rawText=e,this.parseHeaderLines(e),t=s;let d=0;const n=this.buffer.byteLength;for(;t<n&&!(t+7>n);){const r=this.dataView.getUint32(t,!0),i=this.dataView.getUint8(t+4),l=this.dataView.getUint16(t+5,!0),a=t+7,y=a+l;if(y>n){console.warn("Line extends beyond file size",t);break}const h=new Uint8Array(this.buffer,a,l);let g=h;i===w.Key?this.crypto.addKey({headerOffset:t,lineFileNumber:d,lineIndent:0,threadId:r,code:i,strLength:l},h):l>0&&(g=this.crypto.decrypt(t,h));let x="",C;if(l>0){const p=this.processTextContent(l,i,g);x=p.text,C=p.textColor}i===w.Time&&(this.currentTime=x),(i===w.Day||i===w.DayRestarted)&&(this.currentDate=x),this.threadFlows.has(r)||this.threadFlows.set(r,new k(r));const c=this.threadFlows.get(r);let u=c.indent;i===w.Entry?c.indent++:i===w.Exit&&(c.indent>0&&c.indent--,u=c.indent);const m={lineIndex:d,fileOffset:t,threadId:r,code:i,length:l,content:x,indent:u,timestamp:this.currentTime,date:this.currentDate,textColor:C};this.lines.push(m),t=y,d++}}parseHeaderLines(t){t.split(/\r?\n/).forEach(s=>{s.startsWith("trace3")?this.header.magic="trace3":s.startsWith("Compiled:")?this.header.compiled=s.substring(10).trim():s.startsWith("OS:")?this.header.os=s.substring(4).trim():s.startsWith("Machine name:")&&(this.header.machineName=s.substring(14).trim())})}processTextContent(t,o,s){let e="",d;o===w.Utf8?e=this.decoderUtf8.decode(s):e=this.decoderAnsi.decode(s);const n="'`I",r="`'",i=e.indexOf(n);if(i!==-1&&e.length>=i+n.length+2+r.length){const l=i+n.length,a=e.substring(l,l+2),y=l+2;if(e.substring(y,y+r.length)===r){const h=parseInt(a,16);if(!isNaN(h)&&h>=0&&h<=15){d=this.getColorFromIndex(h);const g=n.length+2+r.length;e=e.substring(0,i)+e.substring(i+g)}}}return{text:e,textColor:d}}getColorFromIndex(t){return["text-black","text-blue-900","text-green-700","text-teal-700","text-red-900","text-purple-800","text-yellow-700","text-gray-400","text-gray-500","text-blue-600","text-lime-500","text-cyan-500","text-red-600","text-fuchsia-500","text-yellow-400","text-white"][t]||""}}self.onmessage=function(t){const{type:o,arrayBuffer:s}=t.data;if(o==="PARSE")try{const e=new T(s);e.parse();const d=e.lines,n=e.lines.filter(a=>a.code!==w.Time),r=Array.from(new Set(e.lines.map(a=>a.threadId))).sort((a,y)=>a-y),i=e.lines.filter(a=>a.code===w.Error).length,l={type:"SUCCESS",data:{rawLines:d,viewLines:n,uniqueThreadIds:r,header:e.header,errorCount:i}};self.postMessage(l)}catch(e){const d={type:"ERROR",error:e.message||"Unknown error during parsing"};self.postMessage(d)}}})();
